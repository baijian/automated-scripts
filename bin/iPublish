#!/usr/bin/perl -w
use strict;
use warnings;
# for mac egg ache
BEGIN {
    push @INC, '/opt/local/lib/perl5/site_perl/5.12.4';
}
use Net::OpenSSH;
use Term::ANSIColor;

my %confs;
my %servers;
my @errmsg;
my $num = scalar(@ARGV);

#command params selection and handle
if($num == 1) {
    if($ARGV[0] eq "-l" || $ARGV[0] eq "--list"){
        &list_projects;
    } else {
        &show_help;
    }
} elsif($num == 3) {
    if( ($ARGV[0] eq "-p" || $ARGV[0] eq "--project") 
            && ($ARGV[2] eq "-l" || $ARGV[2] eq "--list") )
    {
        my $project_name = $ARGV[1];
        &list_versions($project_name)
    } else {
        &show_help;
    }
} elsif($num == 4) {
    if( ($ARGV[0] eq "-p" || $ARGV[0] eq "--project") 
            && ($ARGV[2] eq "-v" || $ARGV[2] eq "--version") )
    {
        my $project_name = $ARGV[1];
        my $version = $ARGV[3];
        &publish_version($project_name, $version);
    } else {
        &show_help;
    }
} else {
    &show_help;
}

sub publish_version {
    my ($project_name, $version) = @_;
    &load_conf;
    &project_exist_check($project_name);
    foreach(@{$servers{ "$project_name" }}) {
        my $user = $_->{ "user" };
        my $host = $_->{ "host" };
        my $uhost = $user."\@".$host.":";
        my %params = (
            user => $_->{ "user" }
        );
        my $source_dir = $confs{"$project_name"}->{ "source_dir" };
        my $dir = $confs{ "$project_name" }->{"dest_dir"};
        my @args = ("scp", "-r", "$source_dir", $uhost.$dir.$project_name."/".$version);
        my $out = system(@args);
        if ($out == 0) {
            print color("green");
            print "Publish successful.\n";
        } else {
            print color("red");
            print "Publish fail.\n";
        }
        print color("reset");
    }
}

sub list_versions {
    my ($project_name) = @_;
    &load_conf;
    &project_exist_check($project_name);
    #print versions of every server
    foreach(@{$servers{ "$project_name" }}) {
        my $host = $_->{ "host" };
        my %params = (
            user => $_->{ "user" }
        );
        my $dir = $confs{ "$project_name" }->{"dest_dir"};
        my $ssh = Net::OpenSSH->new($host, %params);
        my $cmd = "ls -l $dir".$project_name;
        my @out = $ssh->capture( $cmd );
        shift @out;
        print color("yellow");
        foreach (@out) {
            my @line = split(' ', $_);   
            print pop(@line);
            print "\n";
        }
        print color("reset");
    }
}

sub load_conf {
    if(open(CONF, ".iPublish")) {
        #begin to parser conf
        my $mutex = -1;
        my $project_name;
        my $i = 0;
        while(<CONF>) {
            if($_ =~ m/\s*project\s*\{\s*/i) {
                #project block enter
                $mutex++;
            } elsif(m/\s*name\s*(\w+);\s*/ && $mutex == 0) {
                #project name $1
                $project_name = $1;
                if(exists $confs{$1}) {
                    push($errmsg, "Project $1 duplicated!");
                }
            } elsif(m/\s*source_dir\s*((\/\w+)+);\s*/ && $mutex == 0) {
                #source dir $1
                $confs{"$project_name"}{ "source_dir" } = $1; 
            } elsif(m/\s*dest_dir\s*((\/\w+)+);\s*/ && $mutex == 0) {
                #dest dir $1
                $confs{"$project_name"}{ "dest_dir" } = $1;
            } elsif(m/\s*server\s*\{\s*/ && $mutex == 0) {
                #server block enter
                $mutex++;
            } elsif(m/\s*host\s*(\w+(\w*\.\w*)\w+);\s*/ && $mutex == 1) {
                #one host address $1
                $servers{"$project_name"}[$i]{ 'host' } = $1;
            } elsif(m/\s*user\s*(\w+);\s*/ && $mutex == 1) {
                # host user name $1
                $servers{"$project_name"}[$i]{ 'user' } = $1;
            } elsif(m/\s*\}\s*/ && $mutex == 1) {
                # server block out
                $i++;
                $mutex--;
            } elsif(m/(\s*\}\s*)/ && $mutex == 0) {
                # project block out
                $mutex--;
                $i = 0;
            }
        }
    } else {
        print color("red");
        print "Can not read config file.\n";
        print "Error:$!\n";
        print color("reset");
        exit;
    }  
    close CONF;
    if(scalar(@errmsg) > 0) {
        for(@errmsg) {
            print color("red");
            print $_;
            print "\n";
        }
        print color("reset");
        exit;
    }
}

sub project_exist_check {
    #check project if exists in iPublish
    my ($project_name) = @_;
    if(not exists $confs{"$project_name"}) {
        print color("red");
        print "You have not add project $project_name to iPublish!";
        print "\n";
        print color("reset");
        exit;
    } else {
        #delete redundant project confs
        foreach my $key (keys %confs) {
            if($key ne $project_name){
                delete $confs{$key};
                delete $servers{$key};
            }
        }
    }
}



sub list_projects {
    &load_conf;
    foreach my $project_name ( keys %confs) {
        print $project_name."\n";
        print "\t".$confs{ "$project_name" }->{ "source_dir" }."\n";
        print "\t".$confs{ "$project_name" }->{ "dest_dir" }."\n";
        print "\tServers:\n";
        foreach (@{$servers{ "$project_name" }}) {
            print "\t\t".$_->{ "host" }."\n";
            print "\t\t".$_->{ "user" }."\n";
        }
    }   
}

sub show_help {
    print "Usage : iPublish\n";
    print "\t-h | --help : show help info\n";
    print "\t-l | --list : show all projects you have add to iPublish\n";
    print "\t-p | --project [name] -l | --list : list all versions of your project\n";
    print "\t-p | --project [name] -l | -v | --version [version] : publish a project of a 
        \t\t certain version or a possible version based on date(2013_05_01)\n";
}
